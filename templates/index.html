<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeskSwap - Gestionnaire de fichiers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid #30363d;
        }

        header {
            background: #1f6feb;
            color: white;
            padding: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            flex-wrap: wrap;
        }

        .breadcrumb a {
            color: white;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .breadcrumb a:hover {
            background: rgba(255,255,255,0.2);
        }

        .actions {
            padding: 20px;
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1f6feb;
            color: white;
        }

        .btn-primary:hover {
            background: #388bfd;
        }

        .btn-primary:disabled {
            background: #30363d;
            color: #6e7681;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #238636;
            color: white;
        }

        .btn-secondary:hover {
            background: #2ea043;
        }

        .file-list {
            padding: 20px;
        }

        .file-item {
            display: grid;
            grid-template-columns: auto auto 1fr auto auto auto;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
            align-items: center;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #0d1117;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .file-icon {
            font-size: 20px;
            width: 20px;
            text-align: center;
        }

        .file-name {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-name a {
            color: #c9d1d9;
            text-decoration: none;
        }

        .file-name a:hover {
            color: #58a6ff;
            text-decoration: underline;
        }

        .file-size {
            color: #8b949e;
            font-size: 14px;
            min-width: 80px;
            text-align: right;
        }

        .file-date {
            color: #8b949e;
            font-size: 14px;
            min-width: 150px;
        }

        .file-download {
            min-width: 100px;
        }

        .file-download a {
            display: inline-block;
            padding: 6px 12px;
            background: #1f6feb;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.2s;
        }

        .file-download a:hover {
            background: #388bfd;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6e7681;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .select-info {
            color: #8b949e;
            font-size: 14px;
        }

        .search-bar {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #0d1117;
            color: #c9d1d9;
            font-size: 14px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #1f6feb;
        }

        .search-bar input::placeholder {
            color: #6e7681;
        }

        .search-results {
            padding: 20px;
            background: #0d1117;
            border-top: 1px solid #30363d;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-results-title {
            color: #c9d1d9;
            font-weight: 500;
        }

        .search-close {
            background: #30363d;
            color: #c9d1d9;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-close:hover {
            background: #484f58;
        }

        .upload-zone {
            margin-left: auto;
        }

        .btn-upload {
            background: #8957e5;
            color: white;
        }

        .btn-upload:hover {
            background: #a371f7;
        }

        #uploadInput {
            display: none;
        }

        .upload-progress {
            margin-top: 10px;
            padding: 10px;
            background: #0d1117;
            border-radius: 4px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-message {
            color: #8b949e;
            font-size: 14px;
        }

        .upload-message.success {
            color: #3fb950;
        }

        .upload-message.error {
            color: #f85149;
        }

        .system-metrics {
            padding: 15px 20px;
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 13px;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
        }

        .metric-icon {
            font-size: 16px;
        }

        .metric-label {
            font-weight: 500;
            color: #c9d1d9;
        }

        .metric-value {
            color: #58a6ff;
        }

        .btn-toggle {
            background: #30363d;
            color: #c9d1d9;
        }

        .btn-toggle:hover {
            background: #484f58;
        }

        .btn-toggle.active {
            background: #1f6feb;
            color: white;
        }

        @media (max-width: 768px) {
            .file-item {
                grid-template-columns: auto 1fr;
                gap: 10px;
            }

            .file-size,
            .file-date {
                grid-column: 2;
                font-size: 12px;
                text-align: left;
            }

            .file-download {
                grid-column: 1 / -1;
            }

            .file-download a {
                display: block;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DeskSwap</h1>
            <div class="breadcrumb">
                <a href="/">Racine</a>
                {% if breadcrumb %}
                    {% for crumb in breadcrumb %}
                        <span>/</span>
                        <a href="/{{ crumb.path }}">{{ crumb.name }}</a>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Rechercher un fichier ou dossier...">
            </div>
        </header>

        <div class="system-metrics">
            <div class="metric">
                <span class="metric-icon">üíæ</span>
                <span class="metric-label">Disque:</span>
                <span class="metric-value" id="diskMetric">Chargement...</span>
            </div>
            <div class="metric">
                <span class="metric-icon">üß†</span>
                <span class="metric-label">RAM:</span>
                <span class="metric-value" id="ramMetric">Chargement...</span>
            </div>
            <div class="metric">
                <span class="metric-icon">‚ö°</span>
                <span class="metric-label">CPU:</span>
                <span class="metric-value" id="cpuMetric">Chargement...</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn-primary" id="downloadSelected" disabled>T√©l√©charger la s√©lection</button>
            <button class="btn-secondary" onclick="downloadAll()">T√©l√©charger tout (ZIP)</button>
            <button class="btn-upload" onclick="document.getElementById('uploadInput').click()">üì§ Upload</button>
            <button class="btn-toggle" id="toggleHidden" onclick="toggleHiddenFiles()">üëÅÔ∏è Fichiers cach√©s</button>
            <span class="select-info" id="selectInfo">Aucun fichier s√©lectionn√©</span>
            <div class="upload-progress" id="uploadProgress">
                <div class="upload-message" id="uploadMessage"></div>
            </div>
        </div>

        <input type="file" id="uploadInput" multiple>

        <div class="search-results" id="searchResults">
            <div class="search-results-header">
                <span class="search-results-title" id="searchResultsTitle">R√©sultats de recherche</span>
                <button class="search-close" onclick="closeSearch()">Fermer</button>
            </div>
            <div id="searchResultsContent"></div>
        </div>

        <div class="file-list">
            {% if items %}
                {% for item in items %}
                <div class="file-item">
                    <input type="checkbox" class="checkbox file-checkbox" data-name="{{ item.name }}">
                    <div class="file-icon">
                        {% if item.is_dir %}
                            üìÅ
                        {% else %}
                            üìÑ
                        {% endif %}
                    </div>
                    <div class="file-name">
                        {% if item.is_dir %}
                            <a href="/{{ current_path }}{% if current_path %}/{% endif %}{{ item.name }}">{{ item.name }}</a>
                        {% else %}
                            {{ item.name }}
                        {% endif %}
                    </div>
                    <div class="file-size">
                        {% if not item.is_dir %}
                            {{ format_size(item.size) }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="file-date">
                        {{ item.modified.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    <div class="file-download">
                        {% if item.is_dir %}
                            <a href="/download-all/{{ current_path }}{% if current_path %}/{% endif %}{{ item.name }}">ZIP</a>
                        {% else %}
                            <a href="/download/{{ current_path }}{% if current_path %}/{% endif %}{{ item.name }}">T√©l√©charger</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">üì≠</div>
                    <p>Ce dossier est vide</p>
                </div>
            {% endif %}
        </div>
    </div>

    <form id="downloadForm" method="POST" action="/download-multiple" style="display: none;">
        <input type="hidden" name="current_path" value="{{ current_path }}">
    </form>

    <script>
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const downloadBtn = document.getElementById('downloadSelected');
        const selectInfo = document.getElementById('selectInfo');
        const downloadForm = document.getElementById('downloadForm');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelection);
        });

        function updateSelection() {
            const selected = Array.from(checkboxes).filter(cb => cb.checked);
            const count = selected.length;

            if (count === 0) {
                downloadBtn.disabled = true;
                selectInfo.textContent = 'Aucun fichier s√©lectionn√©';
            } else {
                downloadBtn.disabled = false;
                selectInfo.textContent = `${count} √©l√©ment${count > 1 ? 's' : ''} s√©lectionn√©${count > 1 ? 's' : ''}`;
            }
        }

        downloadBtn.addEventListener('click', () => {
            const selected = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.name);

            if (selected.length === 0) return;

            // Supprimer les anciens inputs
            downloadForm.querySelectorAll('input[name="files[]"]').forEach(input => input.remove());

            // Ajouter les fichiers s√©lectionn√©s
            selected.forEach(name => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'files[]';
                input.value = name;
                downloadForm.appendChild(input);
            });

            downloadForm.submit();
        });

        function downloadAll() {
            const path = '{{ current_path }}';
            window.location.href = '/download-all' + (path ? '/' + path : '');
        }

        // Upload de fichiers
        const uploadInput = document.getElementById('uploadInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadMessage = document.getElementById('uploadMessage');

        uploadInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files[]', file);
            });
            formData.append('current_path', '{{ current_path }}');

            uploadProgress.classList.add('active');
            uploadMessage.className = 'upload-message';
            uploadMessage.textContent = `Envoi de ${files.length} fichier(s)...`;

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadMessage.className = 'upload-message success';
                    uploadMessage.textContent = `‚úì ${result.count} fichier(s) upload√©(s) avec succ√®s`;

                    // Recharger la page apr√®s 2 secondes
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    uploadMessage.className = 'upload-message error';
                    uploadMessage.textContent = `‚úó Erreur: ${result.error || 'Upload √©chou√©'}`;
                }
            } catch (error) {
                uploadMessage.className = 'upload-message error';
                uploadMessage.textContent = `‚úó Erreur: ${error.message}`;
            }

            // R√©initialiser l'input
            uploadInput.value = '';
        });

        // Recherche de fichiers
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchResultsContent = document.getElementById('searchResultsContent');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            clearTimeout(searchTimeout);

            if (query.length < 2) {
                closeSearch();
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        async function performSearch(query) {
            try {
                const response = await fetch(`/search?q=${encodeURIComponent(query)}&path={{ current_path }}`);
                const data = await response.json();

                if (data.results.length === 0) {
                    searchResultsTitle.textContent = 'Aucun r√©sultat trouv√©';
                    searchResultsContent.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>Aucun fichier ou dossier trouv√©</p></div>';
                } else {
                    searchResultsTitle.textContent = `${data.results.length} r√©sultat(s) trouv√©(s)`;
                    searchResultsContent.innerHTML = data.results.map(item => {
                        const icon = item.is_dir ? 'üìÅ' : 'üìÑ';
                        const size = item.is_dir ? '-' : formatSize(item.size);
                        const date = item.modified || '-';
                        const path = item.path;
                        const downloadLink = item.is_dir
                            ? `/download-all/${path}`
                            : `/download/${path}`;
                        const linkHref = item.is_dir ? `/${path}` : '#';

                        return `
                            <div class="file-item">
                                <div class="file-icon">${icon}</div>
                                <div class="file-name">
                                    ${item.is_dir ? `<a href="${linkHref}">${item.name}</a>` : item.name}
                                    <br><small style="color: #6e7681;">${path}</small>
                                </div>
                                <div class="file-size">${size}</div>
                                <div class="file-date">${date}</div>
                                <div class="file-download">
                                    <a href="${downloadLink}">${item.is_dir ? 'ZIP' : 'T√©l√©charger'}</a>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                searchResults.classList.add('active');
            } catch (error) {
                console.error('Erreur de recherche:', error);
            }
        }

        function closeSearch() {
            searchResults.classList.remove('active');
            searchInput.value = '';
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        // Gestion des fichiers cach√©s
        let showHiddenFiles = false;

        function toggleHiddenFiles() {
            showHiddenFiles = !showHiddenFiles;
            const toggleBtn = document.getElementById('toggleHidden');

            if (showHiddenFiles) {
                toggleBtn.classList.add('active');
            } else {
                toggleBtn.classList.remove('active');
            }

            // Recharger la page avec le param√®tre show_hidden
            const currentPath = '{{ current_path }}';
            const baseUrl = currentPath ? `/${currentPath}` : '/';
            const url = new URL(baseUrl, window.location.origin);

            if (showHiddenFiles) {
                url.searchParams.set('show_hidden', 'true');
            }

            window.location.href = url.toString();
        }

        // Charger les m√©triques syst√®me
        async function loadSystemMetrics() {
            try {
                const response = await fetch('/metrics');
                const data = await response.json();

                if (response.ok) {
                    // Formater les m√©triques disque
                    document.getElementById('diskMetric').textContent =
                        `${data.disk.free.toFixed(1)} GB libre / ${data.disk.total.toFixed(1)} GB (${data.disk.percent.toFixed(1)}% utilis√©)`;

                    // Formater les m√©triques RAM
                    document.getElementById('ramMetric').textContent =
                        `${data.ram.used.toFixed(1)} GB / ${data.ram.total.toFixed(1)} GB (${data.ram.percent.toFixed(1)}%)`;

                    // Formater les m√©triques CPU
                    document.getElementById('cpuMetric').textContent =
                        `${data.cpu.percent.toFixed(1)}%`;
                } else {
                    document.getElementById('diskMetric').textContent = 'Erreur';
                    document.getElementById('ramMetric').textContent = 'Erreur';
                    document.getElementById('cpuMetric').textContent = 'Erreur';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des m√©triques:', error);
            }
        }

        // Charger les m√©triques au chargement de la page
        loadSystemMetrics();

        // Recharger les m√©triques toutes les 5 secondes
        setInterval(loadSystemMetrics, 5000);

        // V√©rifier si le param√®tre show_hidden est dans l'URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('show_hidden') === 'true') {
            showHiddenFiles = true;
            document.getElementById('toggleHidden').classList.add('active');
        }
    </script>
</body>
</html>
